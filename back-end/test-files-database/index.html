<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.48" />
    <meta name="description" content="Harker Development documentation.">
<meta name="author" content="Harker Development">

    <link rel="shortcut icon" href="/docs/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/docs/images/favicon.png" type="image/x-icon" />
    <title>Populate Database w/ Test Files :: Harker Development Docs</title>

    
    <link href="/docs/css/nucleus.css?1540323857" rel="stylesheet">
    <link href="/docs/css/fontawesome-all.min.css?1540323857" rel="stylesheet">
    <link href="/docs/css/hybrid.css?1540323857" rel="stylesheet">
    <link href="/docs/css/featherlight.min.css?1540323857" rel="stylesheet">
    <link href="/docs/css/perfect-scrollbar.min.css?1540323857" rel="stylesheet">
    <link href="/docs/css/auto-complete.css?1540323857" rel="stylesheet">
    <link href="/docs/css/theme.css?1540323857" rel="stylesheet">
    <link href="/docs/css/hugo-theme.css?1540323857" rel="stylesheet">
    
      <link href="/docs/css/theme-green.css?1540323857" rel="stylesheet">
    

    <script src="/docs/js/jquery-2.x.min.js?1540323857"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/docs/back-end/test-files-database/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <img src="/docs/img/logo.png"/>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/docs/js/lunr.min.js?1540323857"></script>
<script type="text/javascript" src="/docs/js/auto-complete.js?1540323857"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/harkerdev.github.io\/docs\/";
    
</script>
<script type="text/javascript" src="/docs/js/search.js?1540323857"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/docs/contribution/" title="Contribution" class="dd-item 
        
        
        
        ">
      <a href="/docs/contribution/">
          <b>I. </b>Contribution
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/contribution/github/" title="GitHub Contributions" class="dd-item ">
        <a href="/docs/contribution/github/">
        GitHub Contributions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/contribution/creating-mainting-project/" title="Developing a Project" class="dd-item ">
        <a href="/docs/contribution/creating-mainting-project/">
        Developing a Project
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/front-end/" title="Front End" class="dd-item 
        
        
        
        ">
      <a href="/docs/front-end/">
          <b>II. </b>Front End
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/front-end/add-page/" title="Adding a Page to Node.js Apps" class="dd-item ">
        <a href="/docs/front-end/add-page/">
        Adding a Page to Node.js Apps
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/front-end/reference-partial-page/" title="Referencing a Partial Page" class="dd-item ">
        <a href="/docs/front-end/reference-partial-page/">
        Referencing a Partial Page
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/front-end/frontend-dev/" title="Front End Development Practices" class="dd-item ">
        <a href="/docs/front-end/frontend-dev/">
        Front End Development Practices
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/back-end/" title="Back End" class="dd-item 
        parent
        
        
        ">
      <a href="/docs/back-end/">
          <b>III. </b>Back End
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/back-end/mongodb-access-with-compass/" title="Access MongoDB with Compass" class="dd-item ">
        <a href="/docs/back-end/mongodb-access-with-compass/">
        Access MongoDB with Compass
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/back-end/test-files-database/" title="Populate Database w/ Test Files" class="dd-item active">
        <a href="/docs/back-end/test-files-database/">
        Populate Database w/ Test Files
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/back-end/setting-up-a-server/" title="Setting Up A Server" class="dd-item ">
        <a href="/docs/back-end/setting-up-a-server/">
        Setting Up A Server
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/back-end/mongodb-backup/" title="MongoDB Backup" class="dd-item ">
        <a href="/docs/back-end/mongodb-backup/">
        MongoDB Backup
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      <center>
    <p>Built by The Harker Development Team</p>
</center>
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/docs/'></a> > <a href='/docs/back-end/'>Back End</a> > Populate Database w/ Test Files
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#creating-db-test-files">Creating DB Test files</a>
<ul>
<li><a href="#a-note-on-implementation">A Note on Implementation</a></li>
</ul></li>
<li><a href="#creating-scripts">Creating scripts</a>
<ul>
<li><a href="#unpopulate-script">Unpopulate script</a></li>
<li><a href="#populate-script">Populate script</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Populate Database w/ Test Files</h1>
          

        




<p>Testing often requires a populated database to work with. This tutorial explains how to write a write scripts which populate the database with test documents specified in files you will create.</p>

<h2 id="setup">Setup</h2>

<p>Make sure that MongoDB is set up and <code>mongod</code> is running. Review the structure of your collections. For this tutorial, we will be using users as our example, with the following schema:</p>

<pre><code class="language-json">const mongoose = require('../db');

// Format of the mongoDB collection
const userSchema = mongoose.Schema({
  fullName: {
    type: String,
    required: true,
  },
  username: {
    type: String,
    required: true,
    index: {
      unique: true,
    },
  },
});

// Creating the mongoose model
const User = mongoose.model('User', userSchema);

module.exports = User;
</code></pre>

<h2 id="creating-db-test-files">Creating DB Test files</h2>

<p>In your repository folder, create a new folder titled <code>DatabaseTestFiles</code>. In this folder, create a new file called <code>UserTest.json</code>. Line by line, create a new instance of a user. Here is an example:</p>

<pre><code class="language-json">{&quot;fullName&quot;:&quot;John Doe&quot;,&quot;username&quot;:&quot;19johnd&quot;}
{&quot;fullName&quot;:&quot;Mary Molly&quot;,&quot;username&quot;:&quot;17marym&quot;}
</code></pre>

<p>Note the lack of commas between objects.</p>

<h3 id="a-note-on-implementation">A Note on Implementation</h3>

<p>We are only using a model with two String fields. More models and fields could be added in the same fashion. If a reference field is added, there are two possibilities that could be implemented. The first would be to generate the ids in the database test files, and then reference those ids them in the other document. The other would be to generate documents for both collections separately, then randomly pair them together (depending on the direction of the reference).</p>

<h2 id="creating-scripts">Creating scripts</h2>

<p>If it does not already exist, add a folder to your repository folder titled <code>scripts</code>.</p>

<h3 id="unpopulate-script">Unpopulate script</h3>

<p>In your <code>scripts</code> folder, add a file titled <code>unpopulate.js</code>.
Add the following <code>require</code> block to the beginning of your code:</p>

<pre><code class="language-js">const fs = require('fs');
const readline = require('readline');
const mongoose = require('../db');
const User = require('../models/user');
</code></pre>

<p>If you were to add another model to the populate script, you would add its <code>require</code> reference here.
Then, add the <code>parseUsers</code> function.</p>

<pre><code class="language-js">function parseUsers() {
  return new Promise((resolve, reject) =&gt; {
    const mongoTransactions = [];
    const userRl = readline.createInterface({
      input: fs.createReadStream(`${__dirname}/../DatabaseTestFiles/UserTest.json`),
    });
    userRl.on('line', (data) =&gt; {
      mongoTransactions.push(
        User.findOne(JSON.parse(data))
          .then((user) =&gt; {
            if (!user) throw new Error(`User ith username ${JSON.parse(data).username} does not exist`);
            return user;
          })
          .then(user =&gt; user.remove())
          .then(() =&gt; console.log(`Removed user with username ${JSON.parse(data).username}`))
          .catch((err) =&gt; {
            console.log(`Error removing user from database: ${err}`);
          })
      );
    });
    userRl.on('close', () =&gt; {
      Promise.all(mongoTransactions)
        .then(resolve)
        .catch(reject);
    });
  });
}
</code></pre>

<p>If you wanted to reference another model in User, for example &lsquo;Groceries&rsquo;, you would make a new, similar function but called <code>deleteGroceriesOfUsers</code> and which would take the parameter <code>user</code> and delete all of the groceries that that user referenced. Then, directly after this code block:</p>

<pre><code class="language-js">.then((user) =&gt; {
  if (!user) throw new Error(`User ith username ${JSON.parse(data).username} does not exist`);
  return user;
})
</code></pre>

<p>Add another <code>.then()</code> statement as so:</p>

<pre><code class="language-js">.then(user =&gt; { deleteGroceriesOfUser(user) })
</code></pre>

<p>Finally, at the end of the script, add this execution statement:</p>

<pre><code class="language-js">if (module.parent) {
  module.exports = parseUsers();
} else {
  parseUsers().then(mongoose.disconnect);
}
</code></pre>

<p>This checks to see if this code is being run by another script, which will be important for the <code>populate.js</code> script.</p>

<h3 id="populate-script">Populate script</h3>

<p>In your <code>scripts</code> folder, add a file titled <code>populate.js</code>. Add the following <code>require</code> block to the beginning of your code:</p>

<pre><code class="language-js">const fs = require('fs');
const readline = require('readline');
const mongoose = require('../db');
const User = require('../models/user');
</code></pre>

<p>If you were to add another model to the populate script, you would add its <code>require</code> reference here. Then, add the <code>parseUsers</code> function:</p>

<pre><code class="language-js">function parseUsers() {
  const mongoTransactions = [];
  const users = [];
  const userRl = readline.createInterface({
    input: fs.createReadStream(`${__dirname}/../DatabaseTestFiles/UserTest.json`),
  });
  userRl.on('line', (data) =&gt; {
    const user = new User(JSON.parse(data));
    mongoTransactions.push(
      user.save().then((doc) =&gt; {
        users.push(doc);
      }).then(() =&gt; console.log(`Created user with username ${JSON.parse(data).username}`))
      .catch((err) =&gt; {
        console.log(`Error saving user to database: ${err}`);
      })
    );
  });
}
</code></pre>

<p>This function goes line-by-line through the database test file and creates a new document for each.</p>

<p>If you wanted to reference another model in User, for example &lsquo;Groceries&rsquo;, you would make a new, similar function but called <code>parseGroceries</code> and which would take the parameter <code>users</code>. Then, append the following code inside of the <code>parseUsers</code> function:</p>

<pre><code class="language-js">userRl.on('close', () =&gt; {
  Promise.all(mongoTransactions).then(users =&gt; {
    parseGroceries(users);
  });
});
</code></pre>

<p>Finally, at the end of your code, add this statement:</p>

<pre><code class="language-js">require('./unpopulate').then(parseUsers);
</code></pre>

<p>This makes sure that the database is depopulated before repopulating it.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/docs/back-end/mongodb-access-with-compass/" title="Access MongoDB with Compass"> <i class="fas fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/docs/back-end/setting-up-a-server/" title="Setting Up A Server" style="margin-right: 0px;"><i class="fas fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/docs/js/clipboard.min.js?1540323857"></script>
    <script src="/docs/js/perfect-scrollbar.min.js?1540323857"></script>
    <script src="/docs/js/perfect-scrollbar.jquery.min.js?1540323857"></script>
    <script src="/docs/js/jquery.sticky.js?1540323857"></script>
    <script src="/docs/js/featherlight.min.js?1540323857"></script>
    <script src="/docs/js/html5shiv-printshiv.min.js?1540323857"></script>
    <script src="/docs/js/highlight.pack.js?1540323857"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/docs/js/modernizr.custom.71422.js?1540323857"></script>
    <script src="/docs/js/learn.js?1540323857"></script>
    <script src="/docs/js/hugo-learn.js?1540323857"></script>

    <link href="/docs/mermaid/mermaid.css?1540323857" type="text/css" rel="stylesheet" />
    <script src="/docs/mermaid/mermaid.js?1540323857"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

